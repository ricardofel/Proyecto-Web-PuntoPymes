{% extends "core/base_dashboard.html" %}

{% block header_title %}POA{% endblock %}
{% block header_subtitle %}Detalle del objetivo{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block page_content %}
<div class="max-w-6xl mx-auto space-y-6">

  <div id="objetivo-header" class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 transition-all duration-300">
    {% include "poa/partials/objetivo_header.html" %}
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">

    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
      <div>
        <h3 class="text-lg font-bold text-slate-900">Metas Tácticas</h3>
        <p class="text-sm text-slate-500 mt-0.5">Desglose de metas específicas para cumplir este objetivo.</p>
      </div>

      {% if user.is_superuser or user.es_admin_rrhh or user.es_superadmin_negocio %}
        <button
          type="button"
          onclick="document.getElementById('modalMetaCrear').classList.remove('hidden')"
          hx-get="{% url 'poa:meta_crear' objetivo.id %}"  
          hx-target="#modal-meta-content"
          hx-swap="outerHTML"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 shadow-sm transition-all"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Nueva meta
        </button>
      {% endif %}
    </div>

    <div
      id="metas-container"
      hx-get="{% url 'poa:objetivo_metas' objetivo.id %}"
      hx-trigger="load"
      hx-target="#metas-container"
      hx-swap="innerHTML"
      class="min-h-[200px]"
    >
      <!-- Placeholder mientras HTMX carga el partial -->
      <div class="flex flex-col items-center justify-center py-12 text-slate-400">
        <svg class="animate-spin h-8 w-8 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-medium animate-pulse">Cargando metas...</p>
      </div>
    </div>
  </div>

</div>

<div 
  id="modalObjetivoCrear" 
  class="hidden fixed inset-0 z-50 overflow-y-auto" 
  aria-labelledby="modal-title" 
  role="dialog" 
  aria-modal="true"
>
  <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
  <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
    <div id="modal-objetivo-content"></div> 
  </div>
</div>

<div 
  id="modalMetaCrear" 
  class="hidden fixed inset-0 z-50 overflow-y-auto" 
  aria-labelledby="modal-title" 
  role="dialog" 
  aria-modal="true"
>
  <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
  <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
    <div id="modal-meta-content"></div>
  </div>
</div>

<div 
  id="modalActividadCrear" 
  class="hidden fixed inset-0 z-50 overflow-y-auto" 
  aria-labelledby="modal-title" 
  role="dialog" 
  aria-modal="true"
>
  <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
  <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
    <div id="modal-actividad-content"></div>
  </div>
</div>

<script>
  // Asegura CSRF en requests HTMX.
  document.body.addEventListener('htmx:configRequest', (event) => {
    event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
  });
</script>

<script>
  document.body.addEventListener('close-modal', function(evt) {
      // Cierra modales conocidos que pueden estar abiertos.
      const ids = ['modalObjetivoCrear', 'modalMetaCrear', 'modalActividadCrear'];
      ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
              el.classList.add('hidden');
          }
      });

      // Restaura scroll del body.
      document.body.classList.remove('modal-open');
      document.body.style.overflow = 'auto';

      // Mensaje del servidor (HTMX event) o fallback.
      const msg = evt.detail.value || evt.detail.message || 'Operación exitosa';

      // Muestra toast si SweetAlert2 está disponible.
      if (typeof Swal !== 'undefined') {
          Swal.fire({
              icon: 'success',
              title: msg,
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000
          });
      } else {
          console.warn('SweetAlert2 no está cargado; el modal se cerró correctamente.');
      }
  });
</script>

{% endblock %}
