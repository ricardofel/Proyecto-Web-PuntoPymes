{% extends 'core/base_dashboard.html' %}

{% block header_title %}Editar Perfil{% endblock %}
{% block header_subtitle %}Actualizando información de {{ empleado.nombres }}{% endblock %}

{% block page_content %}
<div class="max-w-6xl mx-auto">

    <div class="mb-6 flex justify-between items-center">
        <a href="{% url 'empleados:lista_empleados' %}" class="text-gray-500 hover:text-gray-700 flex items-center gap-1">
            <span>&larr;</span> Volver al directorio
        </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">

        <div class="md:col-span-1 flex flex-col gap-6 h-full">

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 flex flex-col items-center text-center">
                
                <div class="relative mb-4 group">
                    {% if empleado.foto %}
                        <img src="{{ empleado.foto.url }}" class="w-32 h-32 rounded-full object-cover border-4 border-indigo-50 shadow-md">
                    {% else %}
                        <div class="w-32 h-32 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-3xl font-bold border-4 border-white shadow-md">
                            {{ empleado.nombres|first }}{{ empleado.apellidos|first }}
                        </div>
                    {% endif %}

                    <button type="button" onclick="openPhotoModal()" class="absolute bottom-0 right-0 bg-white text-gray-600 hover:text-indigo-600 p-2 rounded-full shadow-md border border-gray-200 hover:bg-gray-50 transition-all transform hover:scale-110" title="Cambiar foto de perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                        </svg>
                    </button>
                </div>

                <h3 class="text-lg font-bold text-gray-900">{{ empleado.nombres }}</h3>
                <p class="text-indigo-600 font-medium text-sm">{{ empleado.puesto.nombre }}</p>

                <div class="mt-6 w-full border-t pt-4 text-left space-y-3">
                    <div>
                        <span class="text-xs text-gray-400 uppercase font-semibold">Unidad</span>
                        <p class="text-sm text-gray-700">{{ empleado.unidad_org.nombre }}</p>
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 uppercase font-semibold">Ingreso</span>
                        <p class="text-sm text-gray-700">{{ empleado.fecha_ingreso|date:"d M, Y" }}</p>
                    </div>
                    
                    <div>
                        <span class="text-xs text-gray-400 uppercase font-semibold">Estado Actual</span>
                        <span class="block mt-1 px-2 py-1 w-fit rounded-full text-xs font-medium 
                            {% if empleado.estado == 'Activo' %} bg-green-100 text-green-700 
                            {% elif empleado.estado == 'Inactivo' or empleado.estado == 'Suspendido' %} bg-red-100 text-red-700 
                            {% elif empleado.estado == 'Licencia' %} bg-yellow-100 text-yellow-700 
                            {% else %} bg-gray-100 text-gray-700 {% endif %}">
                            {{ empleado.get_estado_display }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Gestión Laboral</h4>
                <a href="{% url 'empleados:lista_contratos' empleado.id %}" class="flex items-center justify-between w-full px-4 py-3 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors font-medium text-sm border border-blue-100">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                        </svg>
                        Ver Historial de Contratos
                    </span>
                    <span>&rarr;</span>
                </a>
            </div>
        </div>

        <div class="md:col-span-2 h-full">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 h-full flex flex-col">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Datos del Empleado</h3>

                <form method="post" enctype="multipart/form-data" class="flex-1 flex flex-col">
                    {% csrf_token %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for field in form %}
                            {% if field.name != 'foto' and field.name != 'estado' %}
                                <div class="flex flex-col {% if field.name == 'direccion' %} md:col-span-2 {% endif %}">
                                    <label class="font-semibold text-gray-600 text-xs mb-1 uppercase">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.errors %}
                                        <span class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}

                        <div class="flex flex-col">
                            <label class="font-semibold text-gray-600 text-xs mb-1 uppercase">Estado del Empleado</label>
                            {{ form.estado }}
                        </div>
                    </div>

                    <div class="mt-auto pt-8 flex items-center justify-end gap-3 border-t">
                        <a href="{% url 'empleados:lista_empleados' %}" class="px-4 py-2 text-gray-600 hover:bg-gray-50 rounded-lg text-sm font-medium">Cancelar</a>
                        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 font-medium transition-all text-sm">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<div id="photoModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-xl transition-all sm:w-full sm:max-w-md">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6">
                    <div class="text-center">
                        <h3 class="text-lg font-bold leading-6 text-gray-900 mb-2">Actualizar Foto</h3>
                        <p class="text-sm text-gray-500 mb-6">Sube una imagen cuadrada (JPG, PNG).</p>

                        <form method="post" action="{% url 'empleados:actualizar_foto' empleado.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <label for="id_foto_input" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="text-sm text-gray-500"><span class="font-semibold">Clic para subir imagen</span></p>
                                    <p class="text-xs text-gray-400 mt-1" id="fileNameDisplay">Sin archivo seleccionado</p>
                                </div>
                                <input id="id_foto_input" name="foto" type="file" class="hidden" accept="image/*" onchange="updateFileName(this)" />
                            </label>

                            <div class="mt-6 flex gap-3">
                                <button type="button" onclick="closePhotoModal()" class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">Cancelar</button>
                                <button type="submit" class="flex-1 px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg font-medium shadow-sm">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openPhotoModal() { 
        document.getElementById('photoModal').classList.remove('hidden'); 
    }
    function closePhotoModal() {
        document.getElementById('photoModal').classList.add('hidden');
        document.getElementById('id_foto_input').value = "";
        document.getElementById('fileNameDisplay').textContent = "Sin archivo seleccionado";
    }
    function updateFileName(input) {
        const name = input.files[0]?.name || "Sin archivo seleccionado";
        document.getElementById('fileNameDisplay').textContent = name;
    }
</script>

{% endblock %}