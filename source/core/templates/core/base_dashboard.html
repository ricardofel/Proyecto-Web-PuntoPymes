{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{% block title %}Talent Track – Panel{% endblock %}</title>

  <link rel="icon" type="image/png" href="{% static 'core/img/talentrack_small.svg' %}" />

  <script src="https://unpkg.com/htmx.org@1.9.12" integrity="sha384-ujb1lZYygJmzgSwoxRggbCHcjc0rB2XoQrxeTUQyRjrOnlCoYta87iKBWq3EsdM2" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // Si el usuario tenía el menú colapsado, aplicamos la clase antes de que se pinte el body
    if (localStorage.getItem("sidebarCollapsed") === "1") {
      document.documentElement.classList.add('preload-collapsed');
    }
  </script>

  <style>
    /* === CONFIGURACIÓN BASE === */
    html { font-size: 14px; }
    @media (min-width: 1024px) { html { font-size: 14px; } }
    [x-cloak] { display: none !important; }

    /* === SCROLLBAR FINO === */
    .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* === ESTILOS DEL SIDEBAR === */
    #sidebar {
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: width;
    }

    .sidebar-text {
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.2s ease-in-out;
    }

    /* Toggle Button */
    .sidebar-toggle { 
        opacity: 0; 
        pointer-events: none; 
        transition: opacity 0.2s ease, transform 0.3s ease;
        z-index: 50; /* Aseguramos que esté por encima */
    }
    
    #sidebar:hover .sidebar-toggle, 
    #sidebar:not(.is-collapsed) .sidebar-toggle { opacity: 1; pointer-events: auto; }
    #sidebar:not(.is-collapsed) .sidebar-toggle svg { transform: rotate(180deg); }

    /* Lógica visual estándar */
    #sidebar.is-collapsed .sidebar-text { opacity: 0; pointer-events: none; display: none; }
    #sidebar.is-collapsed #companySelector { display: none; }
    #sidebar.is-collapsed #logoFull { display: none; }
    #sidebar.is-collapsed #logoSmall { display: block; transition: opacity 0.2s; }
    
    /* --- CORRECCIÓN AQUÍ --- */
    /* Cuando la barra está cerrada Y pasamos el mouse, ocultamos el logo pequeño */
    /* para que no se mezcle con el botón de abrir */
    #sidebar.is-collapsed:hover #logoSmall { opacity: 0; }
    /* ----------------------- */

    #sidebar:not(.is-collapsed) #logoFull { display: block; }
    #sidebar:not(.is-collapsed) #logoSmall { display: none; }

    /* === ESTILOS DE PRE-CARGA (BLOQUEO) === */
    /* Fuerzan el estado cerrado inmediatamente si JS lo detectó en el head */
    html.preload-collapsed #sidebar { width: 4rem !important; } /* w-16 */
    html.preload-collapsed .sidebar-text { display: none !important; }
    html.preload-collapsed #companySelector { display: none !important; }
    html.preload-collapsed #logoFull { display: none !important; }
    html.preload-collapsed #logoSmall { display: block !important; }
    html.preload-collapsed #sidebarNav a { justify-content: center !important; padding-left: 0 !important; padding-right: 0 !important; }
    html.preload-collapsed * { transition: none !important; }
  </style>
  {% block extra_css %}{% endblock %}
</head>

<body class="bg-slate-100 min-h-screen overflow-hidden font-sans text-slate-600">
  
  <div class="flex h-screen w-full">
    
    <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 z-30 overflow-x-hidden h-full relative">
      
      <div id="sidebarHeader" class="h-16 border-b border-slate-100 flex items-center justify-between px-4 flex-shrink-0 relative">
        <a href="{% url 'dashboard' %}" class="flex items-center gap-2 overflow-hidden min-w-0">
          <img id="logoSmall" src="{% static 'core/img/talentrack_small.svg' %}" alt="TT" class="h-8 w-8 object-contain" />
          <img id="logoFull" src="{% static 'core/img/talenttrack_logo.svg' %}" alt="Talent Track" class="h-8 w-auto object-contain" />
        </a>

        <button type="button" id="sidebarToggle" class="sidebar-toggle w-8 h-8 rounded-lg bg-white border border-slate-200 shadow-sm hover:bg-slate-50 text-slate-500 hover:text-blue-600 flex items-center justify-center transition-all absolute right-3" aria-label="Alternar menú">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </div>

      {% if es_superadmin_global and lista_empresas_global %}
      <div id="companySelector" class="px-3 py-4 border-b border-slate-100 relative">
          <button onclick="toggleSidebarDropdown()" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 flex items-center justify-between hover:border-blue-300 hover:bg-blue-50 transition-all group text-left">
              <div class="overflow-hidden">
                  <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider block whitespace-nowrap">Entorno</span>
                  <span class="text-xs font-bold text-slate-700 group-hover:text-blue-700 truncate block">
                      {{ empresa_actual.nombre_comercial|default:"Seleccionar..." }}
                  </span>
              </div>
              <svg id="sidebarArrow" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-transform duration-200 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
          </button>

          <div id="sidebarCompanyMenu" class="hidden absolute left-3 right-3 top-16 bg-white rounded-lg shadow-xl border border-slate-200 z-50 overflow-hidden max-h-64 overflow-y-auto custom-scrollbar">
              {% for emp in lista_empresas_global %}
                  <a href="?empresa_id={{ emp.id }}" class="flex items-center justify-between px-3 py-2 hover:bg-blue-50 transition-colors border-b border-slate-50 last:border-0 group">
                      <span class="text-xs font-medium truncate {% if empresa_actual.id == emp.id %}text-blue-600 font-bold{% else %}text-slate-600 group-hover:text-blue-600{% endif %}">
                          {{ emp.nombre_comercial }}
                      </span>
                      {% if empresa_actual.id == emp.id %}
                          <span class="w-1.5 h-1.5 rounded-full bg-blue-500 flex-shrink-0"></span>
                      {% endif %}
                  </a>
              {% endfor %}
          </div>
      </div>
      <script>
          function toggleSidebarDropdown() {
              const menu = document.getElementById('sidebarCompanyMenu');
              const arrow = document.getElementById('sidebarArrow');
              menu.classList.toggle('hidden');
              arrow.style.transform = menu.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
          }
      </script>
      {% endif %}

      <nav id="sidebarNav" class="flex-1 px-3 py-4 space-y-1 text-sm overflow-y-auto custom-scrollbar">
        
        <a href="{% url 'dashboard' %}" title="Panel" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if request.resolver_match.view_name == 'dashboard' %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
          <span class="sidebar-text">Panel General</span>
        </a>

        <a href="{% url 'asistencia:inicio' %}" title="Asistencia" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'asistencia' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <span class="sidebar-text">Asistencia</span>
        </a>

        {% if request.user.es_admin_rrhh or request.user.is_superuser %}
        <a href="{% url 'empleados:lista_empleados' %}" title="Empleados" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'empleados' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
          </svg>
          <span class="sidebar-text">Empleados</span>
        </a>
        {% endif %}

        <a href="{% url 'solicitudes:lista_solicitudes' %}" title="Solicitudes" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'solicitudes' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
          </svg>
          <span class="sidebar-text">Solicitudes</span>
        </a>

        {% if request.user.es_admin_rrhh or request.user.is_superuser %}
            <a href="{% url 'organizacion' %}" title="Organización" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'organizacion' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
              </svg>
              <span class="sidebar-text">Organización</span>
            </a>

            {% if request.user.puede_ver_modulo_usuarios %}
            <a href="{% url 'usuarios:lista_usuarios' %}" title="Usuarios" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'usuarios' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
              </svg>
              <span class="sidebar-text">Usuarios</span>
            </a>
            {% endif %}

            <a href="{% url 'kpi:dashboard' %}" title="KPI" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'kpi' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
               </svg>
               <span class="sidebar-text">KPI</span>
            </a>
        {% endif %}

        {% if request.user.is_superuser %}
            <a href="{% url 'auditoria:dashboard' %}" title="Auditoría" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'auditoria' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25M9 16.5v.75m3-3v3M15 12v5.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
               </svg>
               <span class="sidebar-text">Auditoría</span>
            </a>

            <a href="{% url 'integraciones:dashboard' %}" title="Integraciones" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'integracion' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
               </svg>
               <span class="sidebar-text">Integraciones</span>
            </a>
        {% endif %}

        <a href="{% url 'poa:poa' %}" title="POA" class="flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium transition-colors whitespace-nowrap {% if 'poa' in request.path %} bg-blue-50 text-blue-600 {% else %} text-slate-600 hover:bg-slate-100 {% endif %}">
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 flex-shrink-0">
             <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
           </svg>
           <span class="sidebar-text">POA</span>
        </a>
      </nav>
    </aside>

    <div id="mainContent" class="flex-1 flex flex-col min-w-0 bg-slate-100 overflow-hidden h-full relative transition-all duration-300">
      
      <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 flex-shrink-0 shadow-sm z-20">
        <div>
          <h1 class="text-lg font-semibold text-slate-900 leading-tight">
            {% block header_title %}Panel General{% endblock %}
          </h1>
          <p class="text-xs text-slate-500">
            {% block header_subtitle %}Bienvenido al sistema{% endblock %}
          </p>
        </div>

        <div class="flex items-center gap-4 text-slate-500">
          
          <div class="relative">
            <button id="notifBtn" onclick="toggleNotificaciones(event)" class="w-9 h-9 rounded-full bg-slate-50 hover:bg-slate-100 flex items-center justify-center transition-colors relative focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 text-slate-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
              </svg>
              
              {% if conteo_notificaciones > 0 %}
                <span class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[9px] font-bold text-white ring-2 ring-white">
                  {{ conteo_notificaciones }}
                </span>
              {% endif %}
            </button>

            <div id="notifMenu" class="hidden absolute right-0 top-full mt-3 w-80 origin-top-right rounded-xl bg-white shadow-xl ring-1 ring-black ring-opacity-5 z-50">
              <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="text-xs font-bold text-slate-700 uppercase">Notificaciones</h3>
                {% if conteo_notificaciones > 0 %}
                  <a href="{% url 'notificaciones:marcar_todas' %}" class="text-[10px] font-bold text-blue-600 hover:underline">
                    Marcar todas leídas
                  </a>
                {% endif %}
              </div>

              <div class="max-h-64 overflow-y-auto custom-scrollbar">
                {% for notif in ultimas_notificaciones %}
                <a href="{% url 'notificaciones:marcar_leida' notif.id %}" class="block p-3 hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group">
                  <div class="flex gap-3">
                    <div class="flex-shrink-0 mt-1">
                      <div class="w-2 h-2 rounded-full {% if notif.tipo == 'error' %}bg-red-500{% elif notif.tipo == 'exito' %}bg-green-500{% elif notif.tipo == 'alerta' %}bg-yellow-500{% else %}bg-blue-500{% endif %}"></div>
                    </div>
                    <div>
                      <p class="text-xs font-semibold text-slate-800 group-hover:text-blue-600 transition-colors">
                        {{ notif.titulo }}
                      </p>
                      <p class="text-[11px] text-slate-500 mt-0.5 line-clamp-2">
                        {{ notif.mensaje }}
                      </p>
                      <span class="text-[9px] text-slate-400 mt-1 block">
                        {{ notif.fecha_creacion|timesince }}
                      </span>
                    </div>
                  </div>
                </a>
                {% empty %}
                  <div class="py-8 text-center">
                    <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-slate-50 mb-2">
                      <svg class="w-5 h-5 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    </div>
                    <p class="text-xs text-slate-400">Estás al día</p>
                  </div>
                {% endfor %}
              </div>

              <div class="p-2 border-t border-slate-100 bg-slate-50 rounded-b-xl text-center">
                <a href="{% url 'notificaciones:lista_notificaciones' %}" class="text-[10px] font-bold text-slate-500 hover:text-slate-800 uppercase tracking-wide">
                  Ver historial completo
                </a>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-3 pl-4 border-l border-slate-200 h-8">
            <a href="{% url 'usuarios:perfil' %}" class="group flex items-center gap-3 hover:bg-slate-50 rounded-lg pr-2 pl-1 py-1 transition-colors" title="Ver mi perfil">
                
                <div class="hidden md:block text-right leading-tight">
                    <span class="block text-xs font-bold text-slate-700 group-hover:text-blue-600 transition-colors">
                        {% if request.user.empleado %}
                            {{ request.user.empleado.nombres.split.0 }} {{ request.user.empleado.apellidos.split.0 }}
                        {% else %}
                            {{ request.user.email|truncatechars:20 }}
                        {% endif %}
                    </span>
                    <span class="block text-[10px] text-slate-400 font-medium">
                        {{ request.user.empleado.puesto.nombre|default:"Usuario" }}
                    </span>
                </div>

                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold shadow-sm shadow-blue-200 group-hover:ring-2 group-hover:ring-blue-200 transition-all overflow-hidden">
                    {% if request.user.foto_perfil %}
                        <img src="{{ request.user.foto_perfil.url }}" class="w-full h-full object-cover">
                    {% elif request.user.empleado and request.user.empleado.foto %}
                        <img src="{{ request.user.empleado.foto.url }}" class="w-full h-full object-cover">
                    {% else %}
                        {{ request.user.email|slice:":2"|upper }}
                    {% endif %}
                </div>
            </a>

            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="group flex items-center gap-1 text-slate-500 hover:text-red-600 transition ml-1" title="Salir">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5 group-hover:scale-110 transition-transform">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </header>

      {% if messages %}
      <div class="max-w-7xl mx-auto w-full px-6 mt-4">
        {% for message in messages %}
        <div class="p-3 mb-2 rounded-lg text-sm border flex items-center gap-2 animate-fade-in-down {% if message.tags == 'error' %} bg-red-50 text-red-700 border-red-200 {% elif message.tags == 'success' %} bg-green-50 text-green-700 border-green-200 {% else %} bg-blue-50 text-blue-700 border-blue-200 {% endif %}">
           <span>{{ message }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <main class="flex-1 overflow-y-auto custom-scrollbar p-6">
        <div class="w-full max-w-[1920px] mx-auto">
            {% block page_content %}{% endblock %}
        </div>
      </main>
      
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebarToggle");
    
    // Función centralizada para aplicar el estado (JS Standard)
    function applySidebarState(collapsed) {
      if (collapsed) {
        sidebar.classList.remove("w-64");
        sidebar.classList.add("w-16", "is-collapsed");
        
        // Ajuste enlaces
        document.querySelectorAll("#sidebarNav a").forEach(a => {
            a.classList.remove("px-3", "gap-3");
            a.classList.add("justify-center", "px-0");
        });
        
        localStorage.setItem("sidebarCollapsed", "1");
      } else {
        sidebar.classList.remove("w-16", "is-collapsed");
        sidebar.classList.add("w-64");
        
        // Restaurar enlaces
        document.querySelectorAll("#sidebarNav a").forEach(a => {
            a.classList.remove("justify-center", "px-0");
            a.classList.add("px-3", "gap-3");
        });
        
        localStorage.setItem("sidebarCollapsed", "0");
      }
      
      // Disparar evento resize para gráficos
      setTimeout(() => {
          window.dispatchEvent(new Event('resize'));
      }, 300);
    }

    // Toggle click (Manual)
    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("is-collapsed");
      applySidebarState(!isCollapsed);
    });

    // === LÓGICA DE INICIALIZACIÓN ===
    // 1. Verificamos si habíamos pre-cargado el estado colapsado en el head
    const preloadedCollapsed = document.documentElement.classList.contains('preload-collapsed');
    
    // 2. Aplicamos el estado 'real' en el DOM (sin animaciones aún)
    if (preloadedCollapsed) {
        applySidebarState(true);
        // Pequeño timeout para quitar el bloqueo de animación una vez renderizado
        setTimeout(() => {
            document.documentElement.classList.remove('preload-collapsed');
        }, 50);
    } else {
        // Por si acaso no hubo precarga pero el storage dice colapsado (fallback)
        if(localStorage.getItem("sidebarCollapsed") === "1") {
            applySidebarState(true);
        }
    }

    // Lógica Dropdowns
    function toggleNotificaciones(event) {
        event.stopPropagation();
        document.getElementById('notifMenu').classList.toggle('hidden');
    }

    document.addEventListener('click', function(event) {
        const notifMenu = document.getElementById('notifMenu');
        const notifBtn = document.getElementById('notifBtn');
        const companyMenu = document.getElementById('sidebarCompanyMenu');
        
        if (notifMenu && !notifMenu.classList.contains('hidden') && !notifMenu.contains(event.target) && !notifBtn.contains(event.target)) {
            notifMenu.classList.add('hidden');
        }
        if (companyMenu && !companyMenu.classList.contains('hidden') && !event.target.closest('#companySelector')) {
             companyMenu.classList.add('hidden');
             const arrow = document.getElementById('sidebarArrow');
             if(arrow) arrow.style.transform = 'rotate(0deg)';
        }
    });
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>